package bind

import (
	_ "embed"
	"strings"
	"text/template"
)

type GenFileConf struct {
	Entity        any
	Actions       []any
	ConfigBuilder func(act any) *GenFuncConf
}

func GenFile(mod string, items []GenFileConf) (string, error) {
	tmpl, err := template.New("header").Funcs(template.FuncMap{
		"lower": strings.ToLower,
	}).Parse(bindHeaderTmpl)
	if err != nil {
		return "", err
	}

	var file strings.Builder
	var body strings.Builder
	headerData := &headerContext{PackageBase: mod, Entities: make([]string, 0)}
	for _, item := range items {
		for i, act := range item.Actions {
			headerData.addEntity(item.Entity, i)
			body.WriteString(GenBindFunc(item.ConfigBuilder(act)))
		}
	}
	err = tmpl.Execute(&file, headerData)
	if err != nil {
		return "", err
	}
	file.WriteString(body.String())
	return file.String(), nil
}

type headerContext struct {
	PackageBase string
	Entities    []string
}

func (h *headerContext) addEntity(obj any, flag int) {
	if flag != 0 {
		return
	}
	h.Entities = append(h.Entities, getStructName(obj))
}

const bindHeaderTmpl = `
{{$pkgBase := .PackageBase}}
// Code generated by Sphere. DO NOT EDIT.
package render

import (
	"github.com/TBXark/sphere/database/bind"
	"{{$pkgBase}}/api/entpb"
	"{{$pkgBase}}/internal/pkg/database/ent"
{{- range .Entities}}
	"{{$pkgBase}}/internal/pkg/database/ent/{{. | lower}}"
{{- end}}
)

const (
{{- range .Entities}}
	_ = {{. | lower}}.Label
{{- end}}
)
`
